<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="description"
              content="{{ meta_description|default("Order Management Demo") }}">
        <meta name="keywords"
              content="{{ meta_keywords|default("orders, management, demo") }}">
        <title>
            {% block title %}Order Management Demo{% endblock %}
        </title>
        <link rel="stylesheet"
              href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
        <link rel="stylesheet" href="/static/styles.css">
        <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    </head>
    <body>
        {% include "nav.html" %}
        <section class="section">
            <div class="container">
                {% if message %}<div class="notification is-info">{{ message }}</div>{% endif %}
                {% block content %}{% endblock %}
            </div>
        </section>
    </body>
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <script defer src="https://unpkg.com/alpinejs@3.12.0/dist/cdn.min.js"></script>
    <script>
        (function(){
            function getCookie(name){
                const match = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
                return match ? decodeURIComponent(match.pop()) : null;
            }

            const csrf = getCookie('csrf_token');

            function injectToken(form){
                try{
                    if(!csrf) return;
                    if(!(form instanceof HTMLFormElement)) return;
                    if(form.method && form.method.toLowerCase() !== 'post') return;
                    if(form.querySelector && form.querySelector('input[name="csrf_token"]')) return;
                    const inp = document.createElement('input');
                    inp.type = 'hidden';
                    inp.name = 'csrf_token';
                    inp.value = csrf;
                    form.appendChild(inp);
                }catch(e){
                    // defensive: don't break page scripts
                    console.error('csrf-inject error', e);
                }
            }

            function injectAll(){
                document.querySelectorAll && document.querySelectorAll('form').forEach(injectToken);
            }

            document.addEventListener('DOMContentLoaded', injectAll);

            // watch for forms inserted dynamically (HTMX swaps)
            try{
                const mo = new MutationObserver((mutations)=>{
                    for(const m of mutations){
                        m.addedNodes.forEach(node=>{
                            if(node.nodeType !== 1) return;
                            try{
                                if(node.matches && node.matches('form')) injectToken(node);
                            }catch(e){}
                            node.querySelectorAll && node.querySelectorAll('form').forEach(injectToken);
                        });
                    }
                });
                mo.observe(document.documentElement || document.body, {childList:true, subtree:true});
            }catch(e){ /* ignore */ }

            // Add CSRF header for HTMX requests
            if(window.htmx){
                try{
                    htmx.on && htmx.on('htmx:configRequest', function(ev){
                        const token = getCookie('csrf_token');
                        if(token){
                            ev.detail.headers = ev.detail.headers || {};
                            ev.detail.headers['X-CSRF-Token'] = token;
                        }
                    });
                }catch(e){/* ignore */}
            }
        })();
    </script>
</html>
